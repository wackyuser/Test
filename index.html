<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TI Screen</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  height: 100%;
}

#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  display: flex;
  gap: 8px;
  z-index: 10;
}

button {
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
}

#canvasWrap {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

canvas {
  image-rendering: pixelated;
  max-width: 100%;
  max-height: 100%;
}
</style>
</head>

<body>
<div id="ui">
  <button id="connect">Connect</button>
  <button id="shot">Screenshot</button>
  <button id="record">Record</button>
  <button id="hide">Hide UI</button>
</div>

<div id="canvasWrap">
  <canvas id="screen" width="320" height="240"></canvas>
</div>
<script type="module">
import TIVarsLib from "./TIVarsLib.js";

const canvas = document.getElementById("screen");
const ctx = canvas.getContext("2d");
const img = ctx.createImageData(320, 240);

let Module;
let connected = false;
let recording = false;
let recorder;
let recordChunks = [];

function fatal(msg, err) {
  console.error(msg, err || "");
  alert(msg + (err ? "\n\n" + err : ""));
}

async function initWasm() {
  try {
    Module = await TIVarsLib({
      locateFile: p => p
    });
    await Module.ready;
    console.log("WASM ready");
    alert("WASM Ready")
  } catch (e) {
    fatal("Failed to initialize WASM", e);
  }
}

async function connectTI() {
  try {
    if (!Module) {
      fatal("WASM not loaded yet");
      return;
    }

    await navigator.usb.requestDevice({
      filters: [{ vendorId: 0x0451 }]
    });

    const ok = Module._ti_connect();
    if (!ok) {
      fatal("TI connection failed");
      return;
    }

    connected = true;
    console.log("TI connected");
    requestAnimationFrame(loop);

  } catch (e) {
    fatal("USB connection error", e);
  }
}

function loop() {
  if (!connected) return;

  try {
    Module._ti_read_screen();

    const ptr = Module._ti_get_screen_ptr();
    const size = Module._ti_get_screen_size();

    if (!ptr || size !== 320 * 240 * 2) {
      fatal("Invalid screen buffer", { ptr, size });
      connected = false;
      return;
    }

    const buf = Module.HEAPU8.subarray(ptr, ptr + size);

    let j = 0;
    for (let i = 0; i < buf.length; i += 2) {
      const v = buf[i] | (buf[i + 1] << 8);

      img.data[j++] = ((v >> 11) & 31) * 255 / 31;
      img.data[j++] = ((v >> 5) & 63) * 255 / 63;
      img.data[j++] = (v & 31) * 255 / 31;
      img.data[j++] = 255;
    }

    ctx.putImageData(img, 0, 0);

  } catch (e) {
    fatal("Screen read failed", e);
    connected = false;
    return;
  }

  requestAnimationFrame(loop);
}

/* UI */

document.getElementById("connect").onclick = connectTI;

document.getElementById("shot").onclick = () => {
  try {
    const a = document.createElement("a");
    a.download = "ti-screen.png";
    a.href = canvas.toDataURL("image/png");
    a.click();
  } catch (e) {
    fatal("Screenshot failed", e);
  }
};

document.getElementById("record").onclick = () => {
  try {
    if (!recording) {
      const stream = canvas.captureStream(60);
      recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
      recordChunks = [];

      recorder.ondataavailable = e => recordChunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(recordChunks, { type: "video/webm" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "ti-screen.webm";
        a.click();
      };

      recorder.start();
      recording = true;
      document.getElementById("record").textContent = "Stop";
    } else {
      recorder.stop();
      recording = false;
      document.getElementById("record").textContent = "Record";
    }
  } catch (e) {
    fatal("Recording error", e);
  }
};

document.getElementById("hide").onclick = () => {
  document.getElementById("ui").style.display = "none";
};

navigator.usb.addEventListener("disconnect", () => {
  connected = false;
  alert("Calculator disconnected");
});

initWasm();
</script>
</body>
</html>

