<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TI Screen</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  overflow: hidden;
  height: 100%;
}

#ui {
  position: fixed;
  top: 10px;
  left: 10px;
  display: flex;
  gap: 8px;
  z-index: 10;
}

button {
  padding: 8px 12px;
  font-size: 14px;
  cursor: pointer;
}

#canvasWrap {
  width: 100vw;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

canvas {
  image-rendering: pixelated;
  max-width: 100%;
  max-height: 100%;
}
</style>
</head>

<body>
<div id="ui">
  <button id="connect">Connect</button>
  <button id="shot">Screenshot</button>
  <button id="record">Record</button>
  <button id="hide">Hide UI</button>
</div>

<div id="canvasWrap">
  <canvas id="screen" width="320" height="240"></canvas>
</div>

<script type="module">
import TIVarsLib from "./TIVarsLib.js";

const canvas = document.getElementById("screen");
const ctx = canvas.getContext("2d");
const img = ctx.createImageData(320, 240);

let Module;
let connected = false;
let recording = false;
let recorder;
let recordChunks = [];

const TI_USB_FILTERS = [
  { vendorId: 0x0451 } // Texas Instruments
];

async function initWasm() {
  Module = await TIVarsLib({
    locateFile: p => p
  });
  await Module.ready;
  console.log("WASM ready");
  alert("WASM ready")
}

async function connectTI() {
  if (connected) return;

  await navigator.usb.requestDevice({ filters: TI_USB_FILTERS });

  const ok = Module._ti_connect();
  if (!ok) {
    alert("Failed to connect");
    return;
  }

  connected = true;
  loop();
}

function loop() {
  if (!connected) return;

  const ptr = Module._ti_get_screen_ptr();
  const buf = Module.HEAPU8.subarray(ptr, ptr + 320 * 240 * 2);

  let j = 0;
  for (let i = 0; i < buf.length; i += 2) {
    const rgb565 = buf[i] | (buf[i + 1] << 8);
    const r = ((rgb565 >> 11) & 0x1F) * 255 / 31;
    const g = ((rgb565 >> 5) & 0x3F) * 255 / 63;
    const b = (rgb565 & 0x1F) * 255 / 31;

    img.data[j++] = r;
    img.data[j++] = g;
    img.data[j++] = b;
    img.data[j++] = 255;
  }

  ctx.putImageData(img, 0, 0);
  requestAnimationFrame(loop);
}

document.getElementById("connect").onclick = connectTI;

document.getElementById("shot").onclick = () => {
  const a = document.createElement("a");
  a.download = "ti-screen.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
};

document.getElementById("record").onclick = () => {
  if (!recording) {
    const stream = canvas.captureStream(60);
    recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    recordChunks = [];

    recorder.ondataavailable = e => recordChunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(recordChunks, { type: "video/webm" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "ti-screen.webm";
      a.click();
    };

    recorder.start();
    recording = true;
    document.getElementById("record").textContent = "Stop";
  } else {
    recorder.stop();
    recording = false;
    document.getElementById("record").textContent = "Record";
  }
};

document.getElementById("hide").onclick = () => {
  document.getElementById("ui").style.display = "none";
};

navigator.usb.addEventListener("disconnect", () => {
  connected = false;
  setTimeout(connectTI, 1000);
});

initWasm();
</script>
</body>
</html>

